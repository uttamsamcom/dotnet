name: Build and Deploy to IIS on Commit

on:
  push:  # Trigger workflow on commits to any branch
    branches:
      - '**'  # Or specify branches like 'main'

jobs:
  build:
    runs-on: windows-latest

    steps:
    # Step 1: Checkout the code
    - name: Checkout Code
      uses: actions/checkout@v3

    # Step 2: Setup .NET SDK
    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: 8.0 

    # Step 3: Restore dependencies
    - name: Restore Dependencies
      run: dotnet restore

    # Step 4: Build and Publish the project
    - name: Build Project
      run: dotnet publish -c Release -o ./output

    # Step 5: Upload build artifacts for later use
    - name: Upload Build Artifacts
      uses: actions/upload-artifact@v3
      with:
        name: app-build
        path: ./output

  deploy:
    needs: build
    runs-on: windows-latest

    steps:
    # Step 1: Download the built artifacts
    - name: Download Build Artifacts
      uses: actions/download-artifact@v3
      with:
        name: app-build

    # Step 2: Deploy files to IIS Server via FTP
    - name: Deploy to IIS
      uses: garygrossgarten/github-action-ftp@v3
      with:
        host: ${{ secrets.IIS_HOST }}
        username: ${{ secrets.IIS_USERNAME }}
        password: ${{ secrets.IIS_PASSWORD }}
        local-dir: ./output
        remote-dir: /path/to/your/iis/site # Replace with your IIS site directory

    # Step 3: Restart IIS Application Pool
    - name: Restart IIS Application Pool
      run: |
        ssh -o StrictHostKeyChecking=no ${{ secrets.IIS_USERNAME }}@${{ secrets.IIS_HOST }} "powershell Restart-WebAppPool -Name 'YourAppPoolName'"
      env:
        SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}

    - name: Deploy to IIS
      run: |
        $sourcePath = "$(System.DefaultWorkingDirectory)\app-build"
        $destinationPath = "C:\inetpub\wwwroot\YourIISSite"  # Update this path to your IIS site

        # Stop IIS App Pool (optional)
        Stop-WebAppPool -Name "YourAppPoolName"

        # Copy files to IIS site directory
        Copy-Item -Path $sourcePath\* -Destination $destinationPath -Recurse -Force

        # Start IIS App Pool
        Start-WebAppPool -Name "YourAppPoolName"

      shell: pwsh
      env:
        IIS_USERNAME: ${{ secrets.IIS_USERNAME }}
        IIS_PASSWORD: ${{ secrets.IIS_PASSWORD }}

    # Step 3: Restart IIS Application Pool
    - name: Restart IIS Application Pool
      run: |
        ssh -o StrictHostKeyChecking=no ${{ secrets.IIS_USERNAME }}@${{ secrets.IIS_HOST }} "powershell Restart-WebAppPool -Name 'YourAppPoolName'"
      env:
        SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
